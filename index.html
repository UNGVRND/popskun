<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BOSS TRACKER</title>

<!-- DESIGNER FONTS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
 --neon-green:#00ff9c;
 --neon-blue:#0094ff;
 --neon-red:#ff3b3b;
 --gold:#ffd700;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:#0b0b0b;
  color:var(--gold);
  font-family:'Rajdhani', sans-serif;
  padding:40px 40px 40px 300px;
}

/* TITLE */
h1{
  text-align:center;
  color:#fff;
  font-size:65px;
  font-weight:900;
  letter-spacing:4px;
  margin-bottom:18px;
  font-family:'Orbitron', sans-serif;
  text-shadow:0 0 0px rgba(255,215,0,.5);
}

/* UG LOGO - STABLE */
#rightLogo{
  position:absolute;
  top:25px;
  right:15px;
  width:160px;
  height:160px;
  z-index:2;
}
#rightLogo img{
  max-width:100%;
  filter: drop-shadow(0 0 12px rgba(0,255,255,0.35)) drop-shadow(0 0 12px rgba(255,0,255,0.35));
}

/* LEFT PANEL */
#nextBossPanel{
 position:fixed;
 left:20px;
 top:25px;
 width:260px;
 background:#111;
 border:3px solid var(--neon-green);
 border-radius:35px;
 padding:25px;
 box-shadow:0 0 25px rgba(0,255,156,0.35);
 font-family:'Orbitron', sans-serif;
 z-index:3;
}

#nextBossPanel h3{text-align:center;color:#eeeeee;letter-spacing:3px}
#nextBossName{text-align:center;font-size:2em;margin-top:10px}
#nextBossTimer{text-align:center;font-size:2.4em;margin:10px 0;color:#ffffff}
#nextBossTime{text-align:center;font-size:.85em;color:#ffd400}

/* CONTROLS */
.top-controls{
 width:240px;
 margin:10px auto 30px;
 display:flex;
 flex-direction:column;
 gap:12px;
}

.control-bar{
 width:100%;
 height:46px;
 border:none;
 font-size:15px;
 font-weight:900;
 letter-spacing:2px;
 cursor:pointer;
 border-radius:10px;
 transition:.25s;
 display:flex;
 align-items:center;
 justify-content:center;
 font-family:'Orbitron', sans-serif;
}

/* Hover UI */
.control-bar:hover{
 transform:scale(1.03);
 box-shadow:0 0 18px rgba(255,255,255,.35);
}

.control-sort{background:#39ff14;color:#000;}
.control-sort.off{background:#ff3b3b;color:#fff;}
.control-reset{background:#0094ff;color:#fff;}
.control-sound{background:#ffd700;color:#000;}
.control-sound.off{background:#666;color:#fff;}

/* GRID */
.container{
 display:flex;
 flex-wrap:wrap;
 gap:22px;
 justify-content:center;
}

/* CARDS */
.card{
 background:#111;
 border:2px solid var(--gold);
 border-radius:16px;
 padding:18px;
 width:300px;
 text-align:center;
 transition:.25s;
 position:relative;
 box-shadow:0 0 15px rgba(0,0,0,.6);
}

/* Card hover */
.card:hover{
 transform:translateY(-6px) scale(1.01);
 box-shadow:0 0 30px rgba(0,255,255,.35);
}

.card.next{
 border-color:var(--neon-green);
 box-shadow:0 0 30px rgba(0,255,156,0.6);
}

.card h2{
 color:#fff;
 font-size:26px;
 letter-spacing:2px;
 font-family:'Orbitron', sans-serif;
}

.timer{
 font-size:44px;
 font-weight:900;
 color:#fff;
 font-family:'Orbitron', sans-serif;
 margin:12px 0;
}

/* CALENDAR PANEL */
.calendar-panel{
 margin-top:10px;
 width:100%;
 background:#050505;
 border:2px solid #00ffcc;
 border-radius:10px;
 padding:10px;
 box-shadow:0 0 12px rgba(0,255,204,.6);
 transition:.25s;
}

/* Calendar hover */
.calendar-panel:hover{
 box-shadow:0 0 22px rgba(0,255,204,.9);
}

.calendar-display{
 font-size:11px;
 letter-spacing:2px;
 color:#00ffcc;
 margin-bottom:6px;
 text-align:left;
 font-family:'Orbitron', sans-serif;
}

/* DATETIME PICKER */
.datetime-input{
 width:100%;
 height:42px;
 background:#000;
 color:#ffffff;
 border:2px solid #00ffcc;
 border-radius:6px;
 padding:6px 10px;
 font-size:18px;
 outline:none;
 font-family:'Rajdhani', sans-serif;
 opacity:1;
 transition:.25s;
}

/* Input hover */
.datetime-input:hover{
 box-shadow:0 0 15px rgba(0,255,204,.9);
}

/* Calendar icon visible */
.datetime-input::-webkit-calendar-picker-indicator{
 filter: invert(1);
 opacity: 1;
 cursor: pointer;
}

/* BUTTONS */
button{
 width:100%;
 margin-top:10px;
 padding:12px;
 font-weight:bold;
 cursor:pointer;
 border:none;
 border-radius:8px;
 transition:.25s;
 font-family:'Orbitron', sans-serif;
 letter-spacing:2px;
}

/* Button hover UI */
button:hover{
 transform:scale(1.03);
 box-shadow:0 0 18px rgba(255,255,255,.35);
}

.set-manual{background:#0094ff;color:#fff;}
.killed-now{background:#ff3b3b;color:#fff;}

/* Danger pulse */
@keyframes dangerPulse {
  0%{text-shadow:0 0 10px rgba(255,0,0,0.5);}
  50%{text-shadow:0 0 35px rgba(255,0,0,0.9);}
  100%{text-shadow:0 0 10px rgba(255,0,0,0.5);}
}

#nextBossTimer.danger{
 color:#ff2a2a !important;
 animation: dangerPulse 1.2s infinite;
}

/* =========================
   âœ… KILL HISTORY PANEL
   ========================= */
#historyPanel{
  position:fixed;     /* stays on screen */
  left:20px;         /* move right from left panel */
  top:380px;          /* move down */
  width:320px;
  max-height:460px;
  overflow-y:auto;
  background:#111;
  border:2px solid #00ffcc;
  border-radius:15px;
  padding:12px;
  box-shadow:0 0 20px rgba(0,255,204,.5);
  font-family:'Orbitron', sans-serif;
  z-index:9999;
}


#historyPanel h3{
 text-align:center;
 margin:0 0 10px;
 color:#00ffcc;
 letter-spacing:2px;
}

#historyList{
 display:flex;
 flex-direction:column;
 gap:6px;
}

.history-item{
 font-size:16px;
 padding:8px 6px;
 border-bottom:1px solid #333;
 color:#89fc00;
 line-height:1.35;
}

.history-actions{
 display:flex;
 gap:8px;
 margin-top:10px;
}

.small-btn{
 flex:1;
 padding:10px 8px;
 border-radius:10px;
 font-size:12px;
 font-weight:900;
 letter-spacing:1px;
 cursor:pointer;
 border:none;
 font-family:'Orbitron', sans-serif;
 transition:.2s;
}

.small-btn:hover{
 transform:scale(1.03);
 box-shadow:0 0 18px rgba(255,255,255,.25);
}

.btn-clear{ background:#ff3b3b; color:#fff; }
.btn-refresh{ background:#0094ff; color:#fff; }

#pinInput{
 width:100%;
 height:38px;
 border-radius:10px;
 border:2px solid #00ffcc;
 background:#000;
 color:#fff;
 padding:0 10px;
 margin-top:10px;
 font-family:'Orbitron', sans-serif;
 letter-spacing:1px;
}

#pinError{
 font-size:12px;
 margin-top:6px;
 font-family:'Orbitron', sans-serif;
 letter-spacing:1px;
}
</style>
</head>

<body>

<div id="rightLogo"><img src="logo.png" alt="Logo"></div>

<div id="nextBossPanel">
 <h3>NEXT SPAWN</h3>
 <div id="nextBossName">---</div>
 <div id="nextBossTimer">--:--:--</div>
 <div id="nextBossTime">---</div>
</div>

<h1>BOSS TRACKER</h1>

<!-- âœ… KILL HISTORY PANEL -->
<div id="historyPanel">
  <h3>ðŸ“œ KILL HISTORY</h3>
  <div id="historyList"></div>

  <div class="history-actions">
    <button class="small-btn btn-refresh" onclick="refreshHistory()">REFRESH</button>
    <button class="small-btn btn-clear" onclick="clearHistory()">CLEAR</button>
  </div>

  <input id="pinInput" type="password" placeholder="Admin PIN">
  <div id="pinError"></div>
</div>

<div class="top-controls">
  <button class="control-bar control-sort" id="sortBtn">AUTO SORT: ON</button>
  <button class="control-bar control-reset" onclick="resetAll()">RESET ALL</button>
  <button class="control-bar control-sound" id="soundBtn">ALARM: ON</button>
</div>

<div class="container" id="bossContainer"></div>

<audio id="sound"><source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  /* âœ… YOUR FIREBASE CONFIG (keep yours) */
  const firebaseConfig = {
    apiKey: "AIzaSyDoorwXRVfitvWJ6aldC2C2l3jOXAXKXF4",
    authDomain: "ian-tan.firebaseapp.com",
    databaseURL: "https://ian-tan-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ian-tan",
    storageBucket: "ian-tan.firebasestorage.app",
    messagingSenderId: "708212500342",
    appId: "1:708212500342:web:fb0d881c28aaecb2a87c57"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /* âœ… SERVER TIME SYNC (fix +12 sec issues) */
  let serverOffset = 0;
  let serverReady = false;

  db.ref(".info/serverTimeOffset").on("value", snap => {
    serverOffset = snap.val() || 0;
    serverReady = true;
  });
</script>

<script>
/* =========================
   âœ… SETTINGS
   ========================= */
const HISTORY_LIMIT = 200;     // show last 200 logs
const ADMIN_PIN = "1234";      // change this

let inputLock=false;
document.addEventListener("focusin",e=>{if(e.target.type==="datetime-local") inputLock=true;});
document.addEventListener("focusout",e=>{if(e.target.type==="datetime-local") inputLock=false;});

const bosses=[
 {id:"1",name:"MP CAMPUS",respawn:1},
 {id:"2",name:"SG CAMPUS",respawn:1},
 {id:"3",name:"PH CAMPUS",respawn:1},
 {id:"4",name:"MP HOLE",respawn:1},
 {id:"5",name:"PH HOLE",respawn:1},
 {id:"6",name:"EF MP HOLE",respawn:2},
 {id:"7",name:"EF PH HOLE",respawn:2},
 {id:"8",name:"EF SG HOLE",respawn:2},
 {id:"9",name:"DARK SWORDSMAN",respawn:2},
 {id:"10",name:"NINJA KNIFE",respawn:2},
 {id:"11",name:"CH-1 NINJA KNIFE",respawn:2},
 {id:"12",name:"CH-1 EF MP HOLE",respawn:2},
 {id:"13",name:"CH-1 EF PH HOLE",respawn:2},
 {id:"14",name:"CH-1 EF SG HOLE",respawn:2},
 {id:"15",name:"CH-1 DARK SWORDSMAN",respawn:2},
 {id:"16",name:"CH-1 SG CAMPUS",respawn:1},
];

const container=document.getElementById("bossContainer");
const sound=document.getElementById("sound");
const sortBtn=document.getElementById("sortBtn");
const soundBtn=document.getElementById("soundBtn");
const nextBossTimer=document.getElementById("nextBossTimer");

let autoSort=true;
let alarmOn=true;
let alerted={};
let lastBeepSecond=null;

function speak(text){
 try{
   const u=new SpeechSynthesisUtterance(text);
   speechSynthesis.speak(u);
 }catch(e){}
}

/* =========================
   âœ… BUILD CARDS
   ========================= */
bosses.forEach(b=>{
 const card=document.createElement("div");
 card.className="card";
 card.id=b.id+"-card";
 card.innerHTML=`
  <h2>${b.name}</h2>
  <div class="timer" id="${b.id}-timer">--:--:--</div>
  <div id="${b.id}-next">Next Spawn: --</div>

  <div class="calendar-panel">
    <div class="calendar-display">Select Date & Time</div>
    <input type="datetime-local" class="datetime-input" id="${b.id}-input">
  </div>

  <button class="set-manual" onclick="manual('${b.id}',${b.respawn})">Set Manual</button>
  <button class="killed-now" onclick="now('${b.id}',${b.respawn})">Killed Now</button>
 `;
 container.appendChild(card);
});

/* =========================
   âœ… TOP BUTTONS
   ========================= */
sortBtn.onclick=()=>{
 autoSort=!autoSort;
 sortBtn.textContent="AUTO SORT: "+(autoSort?"ON":"OFF");
 sortBtn.classList.toggle("off",!autoSort);
};

soundBtn.onclick=()=>{
 alarmOn=!alarmOn;
 soundBtn.textContent="ALARM: "+(alarmOn?"ON":"SILENT");
 soundBtn.classList.toggle("off",!alarmOn);
};

/* =========================
   âœ… HISTORY
   ========================= */
function renderHistory(items){
  const historyList = document.getElementById("historyList");
  historyList.innerHTML = "";

  if(!items || items.length === 0){
    const empty = document.createElement("div");
    empty.className = "history-item";
    empty.textContent = "No logs yet. Click Killed Now.";
    historyList.appendChild(empty);
    return;
  }

  items.forEach(item=>{
    const div=document.createElement("div");
    div.className="history-item";
    div.textContent = `${item.name} killed - ${new Date(item.killedAt).toLocaleString()}`;
    historyList.appendChild(div);
  });
}

function refreshHistory(){
  db.ref("history").limitToLast(HISTORY_LIMIT).once("value").then(snapshot=>{
    const data = snapshot.val();
    if(!data) return renderHistory([]);
    const items = Object.values(data).sort((a,b)=>b.killedAt-a.killedAt);
    renderHistory(items);
  });
}

function clearHistory(){
  const pinInput = document.getElementById("pinInput");
  const pinError = document.getElementById("pinError");
  const pin = (pinInput.value || "").trim();

  if(pin !== ADMIN_PIN){
    pinError.style.color = "#ff3b3b";
    pinError.textContent = "âŒ Wrong PIN";
    return;
  }

  if(!confirm("Clear ALL kill history?")) return;

  db.ref("history").remove().then(()=>{
    pinError.style.color = "#00ff9c";
    pinError.textContent = "âœ… History Cleared!";
    pinInput.value = "";
  }).catch(()=>{
    pinError.style.color = "#ff3b3b";
    pinError.textContent = "âŒ Error clearing history";
  });
}

db.ref("history").limitToLast(HISTORY_LIMIT).on("value", snapshot=>{
  const data = snapshot.val();
  if(!data) return renderHistory([]);
  const items = Object.values(data).sort((a,b)=>b.killedAt-a.killedAt);
  renderHistory(items);
});

/* =========================
   âœ… TIMER STORAGE (FIREBASE)
   ========================= */
let firebaseBosses = {};

db.ref("bosses").on("value", snapshot => {
  firebaseBosses = snapshot.val() || {};
});

/* =========================
   âœ… SET NEXT (MANUAL)
   ========================= */
function setNext(id,h,k){
  const nextTime = k.getTime() + h * 3600000;
  db.ref("bosses/" + id).set(nextTime);
  alerted[id] = false;
}

/* =========================
   âœ… BUTTON ACTIONS
   ========================= */
function now(id,h){
  // prevent clicking before server time is ready
  if(!serverReady){
    // small message only (no breaking)
    const pinError = document.getElementById("pinError");
    if(pinError){
      pinError.style.color = "#ffd700";
      pinError.textContent = "â³ Wait 1 second (syncing server time)...";
      setTimeout(()=>{ pinError.textContent=""; }, 1500);
    }
    return;
  }

  const serverNow = Date.now() + serverOffset;
  const nextTime = serverNow + h * 3600000;

  db.ref("bosses/" + id).set(nextTime);
  alerted[id] = false;

  const boss = bosses.find(b => b.id === id);
  db.ref("history").push({
    bossId: id,
    name: boss ? boss.name : ("BOSS " + id),
    killedAt: serverNow
  });
}

function manual(id,h){
  const v=document.getElementById(id+"-input").value;
  if(!v) return alert("Enter time");
  setNext(id,h,new Date(v));
}

function resetAll(){
  if(!confirm("Reset ALL timers?")) return;
  db.ref("bosses").remove();
}

/* =========================
   âœ… MAIN UPDATE LOOP
   ========================= */
function update(){
 if(inputLock) return;
 let soonest=null,soonId=null,sortData=[];

 bosses.forEach(b=>{
  const t = firebaseBosses[b.id];
  const timer=document.getElementById(b.id+"-timer");
  const next=document.getElementById(b.id+"-next");
  const card=document.getElementById(b.id+"-card");
  card.classList.remove("next");

  if (Object.keys(firebaseBosses).length === 0) {
    document.getElementById("nextBossName").textContent = "---";
    document.getElementById("nextBossTimer").textContent = "--:--:--";
    document.getElementById("nextBossTime").textContent = "---";
    document.getElementById("nextBossTimer").classList.remove("danger");
  }

  if (!t) {
    timer.textContent = "--:--:--";
    next.textContent = "Next Spawn: --";
    sortData.push({ id: b.id, time: Infinity });
    return;
  }

  // âœ… server-time countdown
  const nowServer = Date.now() + serverOffset;
  const d = t - nowServer;

  if(d<=0){
   timer.textContent="SPAWNED!";
   next.textContent="NOW";
   if(!alerted[b.id]){
     if(alarmOn){
       sound.currentTime=0;
       sound.play().catch(()=>{});
       speak(b.name+" has spawned");
     }
     alerted[b.id]=true;
   }
   sortData.push({id:b.id,time:0});
   return;
  }

  sortData.push({id:b.id,time:d});
  if(soonest===null||d<soonest){soonest=d;soonId=b.id;}

  const hh=String(Math.floor(d/3600000)).padStart(2,"0");
  const mm=String(Math.floor(d%3600000/60000)).padStart(2,"0");
  const ss=String(Math.floor(d%60000/1000)).padStart(2,"0");
  timer.textContent=`${hh}:${mm}:${ss}`;
  next.textContent="Next: "+new Date(t).toLocaleString();
 });

 if(autoSort){
  sortData.sort((a,b)=>a.time-b.time);
  sortData.forEach(o=>container.appendChild(document.getElementById(o.id+"-card")));
 }

 if(soonId){
  document.getElementById(soonId+"-card").classList.add("next");
  const b=bosses.find(x=>x.id===soonId);
  document.getElementById("nextBossName").textContent=b.name;
  document.getElementById("nextBossTimer").textContent=document.getElementById(soonId+"-timer").textContent;

  const soonTs = firebaseBosses[soonId];
  document.getElementById("nextBossTime").textContent = soonTs
    ? ("Spawns at: " + new Date(soonTs).toLocaleString())
    : "---";

  if(soonest<=10000&&soonest>0){
    const sec=Math.ceil(soonest/1000);
    if(lastBeepSecond!==sec){
      if(alarmOn){
        sound.currentTime=0;
        sound.play().catch(()=>{});
      }
      lastBeepSecond=sec;
    }
  }else{ lastBeepSecond=null; }

  if(soonest<=5*60*1000){
    nextBossTimer.classList.add("danger");
  }else{
    nextBossTimer.classList.remove("danger");
  }
 }
}

setInterval(update,1000);
</script>

</body>
</html>
